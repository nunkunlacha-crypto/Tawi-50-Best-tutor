<style>
    /* ส่วนเดิมของคุณที่มีอยู่... */
    
    .button-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn-print { background-color: #2e7d32; }
    .btn-print:hover { background-color: #1b5e20; }

    /* CSS สำหรับการพิมพ์ (Print Mode) */
    @media print {
        body * { visibility: hidden; }
        #resultOutput, #resultOutput * { visibility: visible; }
        #resultOutput { position: absolute; left: 0; top: 0; width: 100%; }
        .btn-print, .input-group, h1, #status-message { display: none !important; }
        .tawi50-form { border: 1px solid #000; }
    }
</style>

<script>
// --- แก้ไข COL_END_IDX เป็น 15 เพื่อครอบคลุมถึงคอลัมน์ P ---
const COL_START_IDX = 1; 
const COL_END_IDX = 15; 

function searchTawi50() {
    const rawInput = document.getElementById('taxIdInput').value.trim();
    const taxId = rawInput.replace(/[^0-9]/g, ''); 
    resultOutput.innerHTML = ''; 

    if (tawi50Data.length === 0) {
        resultOutput.innerHTML = '<p class="status-error">ยังไม่มีข้อมูลในระบบ กรุณารอสักครู่</p>';
        return;
    }

    if (taxId.length !== 13) {
        resultOutput.innerHTML = '<p class="status-error">กรุณากรอกเลขประจำตัวผู้เสียภาษีอากร 13 หลักให้ถูกต้อง</p>';
        return;
    }
    
    const foundData = tawi50Data.find(item => 
        String(item[taxIdKeyName]).trim().replace(/[^0-9]/g, '') === taxId
    );

    if (foundData) {
        let html = '<div class="tawi50-form">';
        html += '<h3>หนังสือรับรองการหักภาษี ณ ที่จ่าย (50 ทวิ)</h3>';
        html += '<table><tbody>';

        // กำหนดรายการและลำดับการแสดงผล
        const displayFields = [
            { label: 'เลขประจำตัวผู้เสียภาษี (ผู้มีเงินได้)', key: taxIdKeyName },
            { label: 'ชื่อ - นามสกุล', key: 'ชื่อ - นามสกุล' },
            { label: 'ที่อยู่', key: 'ที่อยู่' },
            { label: 'ประเภทภาษีเงินได้', key: 'ประเภทภาษีเงินได้' }, // เพิ่มรายการนี้
            { label: 'จำนวนเงินที่จ่าย', key: Object.keys(foundData).find(k => k.includes('จำนวนเงินที่จ่าย')) },
            { label: 'ภาษีหักและนำส่งไว้', key: Object.keys(foundData).find(k => k.includes('ภาษีหักและนำส่งไว้')) },
            { label: 'ปีภาษีที่จ่ายเงินได้', key: Object.keys(foundData).find(k => k.includes('ปีภาษีที่จ่ายเงินได้')) },
            { label: 'วันที่มีการจ่ายเงิน/ออกเอกสาร', key: Object.keys(foundData).find(k => k.includes('วันที่ออกหนังสือรับรอง')) },
            { label: 'ผู้จ่ายเงินได้', key: 'ชื่อบริษัทที่มีหน้าที่หักภาษี ณ ที่จ่าย' },
            { label: 'เลขประจำตัวผู้เสียภาษี (ผู้จ่ายเงิน)', key: Object.keys(foundData).find(k => k.includes('เลขประจำตัวผู้เสียภาษี บริษัท')) }
        ];

        displayFields.forEach(field => {
            let value = foundData[field.key] || '-';
            
            // จัดรูปแบบตัวเลขยอดเงิน
            if (field.label.includes('เงิน') || field.label.includes('ภาษี')) {
                const num = parseFloat(String(value).replace(/,/g, ''));
                if (!isNaN(num)) {
                    value = `<strong>${num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong> บาท`;
                }
            }
            html += `<tr><th>${field.label}</th><td>${value}</td></tr>`;
        });

        html += '</tbody></table></div>';
        
        // เพิ่มปุ่มพิมพ์ใต้ตาราง
        html += `<div class="button-group">
                    <button class="btn-print" onclick="window.print()">พิมพ์เอกสาร หรือ บันทึกเป็น PDF</button>
                 </div>`;
        
        resultOutput.innerHTML = html;
    } else {
        resultOutput.innerHTML = '<p class="status-error">❌ ไม่พบข้อมูลสำหรับเลขประจำตัวนี้</p>';
    }
}
</script>